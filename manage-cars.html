<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Car Rentals</title>
    <link rel="stylesheet" href="manage-cars.css">
     <link rel="stylesheet" href="admin.css">
</head>
<body>

   <!-- Sidebar -->
    <div class="sidebar">
        <h2>Admin Panel</h2>
        <ul>
           <li><a href="admin.html">Dashboard</a></li>
            <li><a href="add-car.html">Add Car</a></li>
            <li><a href="manage-cars.html">Manage Cars</a></li>
            <li><a href="enquiries.html">Customer Management</a></li>
            <li><a href="pricing-management.html">Pricing Management</a></li>
            <li><a href="financial-reports.html">Financial Reports</a></li>
           <li><a href="clearance.html">Car Maintenance</a></li>
            <li><a href="home.html">Return Home</a></li>
        </ul>
    </div>

    <main>
        <section class="form-section">
            <h2>Allocate Car to Customer</h2>
            <form id="allocateCarForm">
                <label for="carNumberPlate">Car Number Plate:</label>
                <select id="carNumberPlate" name="carNumberPlate" required>
                    <option value="">Select a car</option>
                    <!-- Options will be dynamically populated here by JS -->
                </select>
    

    <label for="customerName">Customer Name:</label>
    <input type="text" id="customerName" name="customerName" required>

    <label for="phoneNumber">Customer Phone Number:</label>
    <input type="text" id="phoneNumber" name="phoneNumber" required>

    <label for="rentalDays">Number of Rental Days:</label>
    <input type="number" id="rentalDays" name="rentalDays" required>

    <label for="customerImage">Customer Image:</label>
    <input type="file" id="customerImage" name="customerImage" accept="image/*" required>

    <label for="agreementImage">Rental Agreement Image:</label>
    <input type="file" id="agreementImage" name="agreementImage" accept="image/*" required>

    <button type="submit">Allocate Car</button>
</form> 
   </section>

        <section class="car-details" id="carDetails">
            <h2>Car Details</h2>
            <div id="carInfo">
                <!-- Car details will be displayed here -->
            </div>
            <div id="rentalCountdown">
                <!-- Countdown timer will be shown here -->
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Car Rental Website</p>
    </footer>

    <script>
        // Function to fetch available cars from the server and populate the dropdown
        async function fetchCarNames() {
            try {
                const response = await fetch('/api/cars');  // Fetch available cars from the API
                const cars = await response.json();
                
                const carSelect = document.getElementById('carNumberPlate');
                
                // Clear existing options
                carSelect.innerHTML = '<option value="">Select a car</option>';
                
                // Populate the dropdown list with car names
                cars.forEach(car => {
                    const option = document.createElement('option');
                    option.value = car.id;  // The car's number plate or ID
                    option.textContent =car.id;  // Display the car name in the dropdown
                    carSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching car data:', error);
            }
        }

        // Handle car allocation form submission
        document.getElementById('allocateCarForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const carNumberPlate = document.getElementById('carNumberPlate').value;
            const customerName = document.getElementById('customerName').value;
            const rentalDays = document.getElementById('rentalDays').value;

            const response = await fetch('/allocate-car', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ numberPlate: carNumberPlate, customerName, rentalDays })
            });

            if (response.ok) {
                alert('Car allocated successfully');
                fetchCarDetails(carNumberPlate);  // Fetch and display car details
            } else {
                alert('Failed to allocate car');
            }
        });

        // Fetch car details by number plate
        async function fetchCarDetails(numberPlate) {
            const response = await fetch(`/car/${numberPlate}`);
            const car = await response.json();

            if (car) {
                document.getElementById('carInfo').innerHTML = `
                    <p>Car Name: ${car.carName}</p>
                    <p>Description: ${car.carDescription}</p>
                    <p>Price: ${car.price} ${car.currency}</p>
                    <p>Status: ${car.status}</p>
                `;
                
                // Calculate rental countdown (if rented)
                if (car.status.startsWith("Rented")) {
                    const rentalEndDate = new Date(car.rentalDetails.rentalEndDate);
                    setInterval(() => {
                        const timeRemaining = rentalEndDate - new Date();
                        const daysRemaining = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
                        document.getElementById('rentalCountdown').innerHTML = `Days Remaining: ${daysRemaining}`;
                    }, 86400000); // Update every day
                }
            }
        }

        // Call fetchCarNames on page load to populate the dropdown
        window.onload = function() {
            fetchCarNames();  // Populate the dropdown with available cars
        };
    </script>

</body>
</html>
